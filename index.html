<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Static Chatbot</title>

  <!-- Bot Framework Web Chat -->
  <script src="https://cdn.botframework.com/botframework-webchat/latest/webchat.js"></script>
<script>
            let webChatInstance = null;
            let directLineUrl = null;
            const tokenEndpoint = "https://default605b6368f7bb49c198403a897e70b5.31.environment.api.powerplatform.com/powervirtualagents/botsbyschema/cr7a8_gsiWebsiteAiTest/directline/token?api-version=2022-03-01-preview";
            const styleOptions = {"accent":"#55C1B1","autoScrollSnapOnPage":true,"autoScrollSnapOnPageOffset":0,"avatarBorderRadius":"50%","avatarSize":38,"backgroundColor":"#FFFFFFFF","botAvatarBackgroundColor":"#FFFFFF","botAvatarImage":"https://i.imgur.com/pKReqIG.png","botAvatarInitials":"B","bubbleAttachmentMaxWidth":480,"bubbleAttachmentMinWidth":250,"bubbleBackground":"#eef8f7","bubbleBorderColor":"#FFFFFF","bubbleBorderRadius":0,"bubbleBorderStyle":"solid","bubbleBorderWidth":1,"bubbleFromUserBackground":"#ddf2ef","bubbleFromUserBorderColor":"#FFFFFF","bubbleFromUserBorderRadius":0,"bubbleFromUserBorderStyle":"solid","bubbleFromUserBorderWidth":1,"bubbleFromUserNubOffset":0,"bubbleFromUserNubSize":0,"bubbleFromUserTextColor":"#06444A","bubbleImageHeight":10,"bubbleImageMaxHeight":240,"bubbleImageMinHeight":240,"bubbleMessageMaxWidth":480,"bubbleMessageMinWidth":120,"bubbleMinHeight":50,"bubbleNubOffset":0,"bubbleTextColor":"","emojiSet":true,"fontSizeSmall":"70%","hideUploadButton":true,"language":"en-US","messageActivityWordBreak":"break-word","monospaceFont":"Segoe UI","paddingRegular":10,"paddingWide":10,"primaryFont":"Segoe UI","sendBoxBackground":"#FFFFFF","sendBoxBorderTop":"solid 1px #55C1B1","sendBoxButtonColor":"#55C1B1","sendBoxButtonColorOnHover":"#4cad9f","sendBoxButtonShadeBorderRadius":40,"sendBoxButtonShadeColorOnHover":"","sendBoxHeight":60,"sendBoxPlaceholderColor":"#032225","sendBoxTextColor":"#06444A","showAvatarInGroup":"status","spinnerAnimationHeight":16,"spinnerAnimationPadding":12,"spinnerAnimationWidth":16,"subtleColor":"#06444A","suggestedActionBackgroundColor":"#55C1B1","suggestedActionBackgroundColorOnHover":"#55C1B1","suggestedActionBorderColor":"","suggestedActionBorderRadius":0,"suggestedActionBorderWidth":1,"suggestedActionLayout":"flow","suggestedActionTextColor":"#FFFFFF","typingAnimationBackgroundImage":"url('https://copilotstudiokit-dev.crm.dynamics.com/WebResources/cat_/powercat/img/loadingdots.gif')","typingAnimationDuration":5000,"typingAnimationHeight":20,"typingAnimationWidth":64,"userAvatarBackgroundColor":"#FFFFFF","userAvatarImage":"","userAvatarInitials":""};
            const backgroundImage = "";
            document.addEventListener('DOMContentLoaded', () => {
              const root = document.documentElement;
              root.style.setProperty('--primary-color', createGradient(styleOptions.accent));
              root.style.setProperty('--header-textColor', styleOptions.suggestedActionTextColor);
              if (backgroundImage) {
                const webchatElement = document.getElementById('webchat');
                webchatElement.style.backgroundImage = `url(${backgroundImage})`;
                webchatElement.style.backgroundSize = 'cover';
                webchatElement.style.backgroundPosition = 'center';
                webchatElement.style.backgroundRepeat = 'no-repeat';
                const overlay = document.createElement('div');
                overlay.className = 'webchat-overlay';
                webchatElement.appendChild(overlay);
              }
            });
            function createGradient(baseColor) {
              const r = parseInt(baseColor.slice(1,3), 16);
              const g = parseInt(baseColor.slice(3,5), 16);
              const b = parseInt(baseColor.slice(5,7), 16);
              const lighterColor = `#${Math.min(255, r+30).toString(16).padStart(2,'0')}${Math.min(255, g+30).toString(16).padStart(2,'0')}${Math.min(255, b+30).toString(16).padStart(2,'0')}`;
              const darkerColor = `#${Math.max(0, r-30).toString(16).padStart(2,'0')}${Math.max(0, g-30).toString(16).padStart(2,'0')}${Math.max(0, b-30).toString(16).padStart(2,'0')}`;
              return `linear-gradient(135deg, ${lighterColor}, ${baseColor}, ${darkerColor})`;
            }
            const environmentEndPoint = tokenEndpoint.slice(
              0,
              tokenEndpoint.indexOf("/powervirtualagents")
            );
            const apiVersion = tokenEndpoint
              .slice(tokenEndpoint.indexOf("api-version"))
              .split("=")[1];
            const regionalChannelSettingsURL = `${environmentEndPoint}/powervirtualagents/regionalchannelsettings?api-version=${apiVersion}`;
            function showChat() {
              const popup = document.getElementById("chatbot-popup");
              const openButton = document.getElementById("open-chat");
              popup.classList.add("visible");
              openButton.classList.add("hidden");
            }
            function hideChat() {
              const popup = document.getElementById("chatbot-popup");
              const openButton = document.getElementById("open-chat");
              popup.classList.remove("visible");
              openButton.classList.remove("hidden");
            }
            function createCustomStore() {
              return window.WebChat.createStore(
                {},
                ({ dispatch }) =>
                  (next) =>
                  (action) => {
                    if (action.type === "DIRECT_LINE/CONNECT_FULFILLED") {
                      dispatch({
                        type: "DIRECT_LINE/POST_ACTIVITY",
                        meta: { method: "keyboard" },
                        payload: {
                          activity: {
                            channelData: { postBack: true },
                            name: "startConversation",
                            type: "event",
                          },
                        },
                      });
                    }
                    return next(action);
                  }
              );
            }
            async function restartConversation() {
              try {
                if (!directLineUrl) {
                  console.error("DirectLine URL not initialized");
                  return;
                }
                const response = await fetch(tokenEndpoint);
                const conversationInfo = await response.json();
                if (!conversationInfo.token) {
                  throw new Error("Failed to get conversation token");
                }
                const newDirectLine = window.WebChat.createDirectLine({
                  domain: `${directLineUrl}v3/directline`,
                  token: conversationInfo.token,
                });
                const webchatElement = document.getElementById("webchat");
                webChatInstance = window.WebChat.renderWebChat(
                  {
                    directLine: newDirectLine,
                    styleOptions,
                    store: createCustomStore(),
                    locale: "en-US"
                  },
                  webchatElement
                );
              } catch (err) {
                console.error("Failed to restart conversation:", err);
              }
            }
            async function initializeChat() {
              try {
                const response = await fetch(regionalChannelSettingsURL);
                const data = await response.json();
                directLineUrl = data.channelUrlsById.directline;
                if (!directLineUrl) {
                  throw new Error("Failed to get DirectLine URL");
                }
                const conversationResponse = await fetch(tokenEndpoint);
                const conversationInfo = await conversationResponse.json();
                if (!conversationInfo.token) {
                  throw new Error("Failed to get conversation token");
                }
                const directLine = window.WebChat.createDirectLine({
                  domain: `${directLineUrl}v3/directline`,
                  token: conversationInfo.token,
                });
                webChatInstance = window.WebChat.renderWebChat(
                  {
                    directLine,
                    styleOptions,
                    store: createCustomStore(),
                    locale: "en-US"
                  },
                  document.getElementById("webchat")
                );
              } catch (err) {
                console.error("Failed to initialize chat:", err);
              }
            }
            initializeChat();
          </script>

  <style>
    :root {
      --primary-color: #55C1B1;
      --header-textColor: #fff;
      --chat-width: 400px;
      --chat-height: 500px;
      --border-radius: 12px;
    }
    body { margin: 0; font-family: system-ui, sans-serif; background: transparent; }
    #chatbot-popup {
      position: fixed;
      bottom: 32px;
      right: 32px;
      width: var(--chat-width);
      height: var(--chat-height);
      background: white;
      border-radius: var(--border-radius);
      box-shadow: 0 18px 40px -5px rgba(0,0,0,0.2);
      overflow: hidden;
      z-index: 999;
    }
    #chatbot-header {
      background: var(--primary-color);
      padding: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: var(--header-textColor);
    }
    #webchat { height: calc(100% - 48px); background-color: #f9fafb; }
    button { cursor: pointer; }
  </style>
</head>
<body>

  <!-- Chatbot Popup (always visible) -->
  <div id="chatbot-popup" role="complementary" aria-label="Chat Assistant">
    <div id="chatbot-header">
      <span>Assistant</span>
      <div>
        <button onclick="restartConversation()">⟳</button>
        <button onclick="hideChat()">✕</button>
      </div>
    </div>
    <div id="webchat" role="main"></div>
  </div>

  <script>
    let webChatInstance = null;

    const tokenEndpoint = "https://default605b6368f7bb49c198403a897e70b5.31.environment.api.powerplatform.com/powervirtualagents/botsbyschema/cr7a8_gsiWebsiteAiTest/directline/token?api-version=2022-03-01-preview";

    const styleOptions = { accent: "#55C1B1", hideUploadButton: true, sendBoxHeight: 50 };

    function hideChat() {
      document.getElementById("chatbot-popup").style.display = "none";
    }
    function createCustomStore() {
      return window.WebChat.createStore({}, ({ dispatch }) => next => action => {
        if (action.type === "DIRECT_LINE/CONNECT_FULFILLED") {
          dispatch({
            type: "DIRECT_LINE/POST_ACTIVITY",
            meta: { method: "keyboard" },
            payload: { activity: { channelData: { postBack: true }, name: "startConversation", type: "event" } }
          });
        }
        return next(action);
      });
    }
    async function restartConversation() {
      const response = await fetch(tokenEndpoint);
      const { token } = await response.json();
      const newDirectLine = window.WebChat.createDirectLine({ token });
      webChatInstance = window.WebChat.renderWebChat(
        { directLine: newDirectLine, styleOptions, store: createCustomStore(), locale: "en-US" },
        document.getElementById("webchat")
      );
    }
    async function initializeChat() {
      const response = await fetch(tokenEndpoint);
      const { token } = await response.json();
      const directLine = window.WebChat.createDirectLine({ token });
      webChatInstance = window.WebChat.renderWebChat(
        { directLine, styleOptions, store: createCustomStore(), locale: "en-US" },
        document.getElementById("webchat")
      );
    }
    initializeChat();
  </script>
</body>
</html>
